<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Test Grid Store Observation</title>

  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/resources/dojo.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojox/mobile/themes/common/domButtons/DomButtonRedCross.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/dgrid.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/skins/claro.css" />

  <style>
    .dgrid {
      margin: 10px;
    }
    .dgrid-grid {
      width: 900px;
    }
    .dgrid-list {
      width: 200px;
    }

    .dgrid .field-pk {
      width: 2em;
    }
    .dgrid .field-order {
      width: 2em;
    }
    .dgrid .field-bool {
      width: 6em;
    }
    .dgrid .field-type {
      width: 10em;
    }
    .dgrid .field-station {
      width: 8em;
    }


    #grid .field-date, #grid .field-date2 {
      width: 16em;
    }
    #grid .field-integer {
      width: 6em;
    }
    #grid .field-bool { /* checkbox */
      width: 4em;
    }
    #grid .field-date, #grid .field-date2 {
      width: 16em;
   }
    #gridAddDel, #listAddDel {
      float: left;
    }
  </style>
  <script>
var start= new Date().getTime();
  </script>

 
  <script>
var dojoConfig = {
  async: true, 
  debug: true,
  packages: [{
    name: "dstore",
    location: "http://cdn.rawgit.com/SitePen/dstore/v1.1.1"
  }, {
    name: "dmodel",
    location: "http://cdn.rawgit.com/SitePen/dmodel/master"
  }, {
    name: "dgrid",
    location: "http://cdn.rawgit.com/SitePen/dgrid/v1.1.0"
  }]
};
  </script>

  <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js"></script>



<script>
require([
    "dgrid/OnDemandGrid", 
    "dgrid/Selection", 
    "dgrid/Keyboard", 
    "dgrid/Editor", 
    "dojo/_base/declare", 
    "dstore/Memory",
    "dstore/Trackable",   
    "dmodel/Model",

    "dojo/data/ObjectStore", 
    "dijit/form/FilteringSelect",
    "dijit/form/ComboBox",
    "dijit/form/Select",
    "dijit/form/Button",

    "dojo/store/Memory", 
    "dojo/store/Observable",
    "dijit/_WidgetBase",


    "dojo/domReady!"],
  function(Grid, Selection, Keyboard, Editor, declare, Memory, Trackable, Model, ObjectStore, FilteringSelect, ComboBox, Select, Button, LegacyMemory, LegacyObservable, _WidgetBase){
    var hours = [
      {name: 0, id: 0},
      {name: 1, id: 1},
      {name: 2, id: 2},
      {name: 3, id: 3},
      {name: 4, id: 4},
      {name: 5, id: 5},
      {name: 6, id: 6},
      {name: 7, id: 7},
      {name: 8, id: 8},
      {name: 9, id: 9},
      {name: 10, id: 10},
      {name: 11, id: 11},
      {name: 12, id: 12},
      {name: 13, id: 13},
      {name: 14, id: 14},
      {name: 15, id: 15},
      {name: 16, id: 16},
      {name: 17, id: 17},
      {name: 18, id: 18},
      {name: 19, id: 19},
      {name: 20, id: 20},
      {name: 21, id: 21},
      {name: 22, id: 22},
      {name: 23, id: 23},
      {name: 24, id: 24},
    ];
    
   var minutes = [
      {label: '0', value: 0},
      {label: '1', value: 1},
      {label: '2', value: 2},
      {label: '3', value: 3},

      {label: 4, value: 4},
      {label: 5, value: 5},
      {label: 6, value: 6},
      {label: 7, value: 7},
      {label: 8, value: 8},
      {label: 9, value: 9},
      {label: 10, value: 10},
      {label: 11, value: 11},
      {label: 12, value: 12},
      {label: 13, value: 13},
      {label: 14, value: 14},
      {label: 15, value: 15},
      {label: 16, value: 16},
      {label: 17, value: 17},
      {label: 18, value: 18},
      {label: 19, value: 19},
      {label: 20, value: 20},
      {label: 21, value: 21},
      {label: 22, value: 22},
      {label: 23, value: 23},
      {label: 24, value: 24},
      {label: 25, value: 25},
      {label: 26, value: 26},
      {label: 27, value: 27},
      {label: 28, value: 28},
      {label: 29, value: 29},
      {label: 30, value: 30},
      {label: 31, value: 31},
      {label: 32, value: 32},
      {label: 33, value: 33},
      {label: 34, value: 34},
      {label: 35, value: 35},
      {label: 36, value: 36},
      {label: 37, value: 37},
      {label: 38, value: 38},
      {label: 39, value: 39},
      {label: 40, value: 40},
      {label: 41, value: 41},
      {label: 42, value: 42},
      {label: 43, value: 43},
      {label: 44, value: 44},
      {label: 45, value: 45},
      {label: 46, value: 46},
      {label: 47, value: 47},
      {label: 48, value: 48},
      {label: 49, value: 49},
      {label: 50, value: 50},
      {label: 51, value: 51},
      {label: 52, value: 52},
      {label: 53, value: 53},
      {label: 54, value: 54},
      {label: 55, value: 55},
      {label: 56, value: 56},
      {label: 57, value: 57},
      {label: 58, value: 58},
      {label: 59, value: 59},*/
    ];


    var hourStore = new LegacyMemory({
      data: hours,
    });

    var DurationInput = declare([_WidgetBase], {
      value: null,
      buildRendering: function () {
        var self = this;
        this.inherited(arguments);

        self._hour = new ComboBox({
          store: hourStore,
          style:{width: "4em"},
        });
        self._minute = new Select({
          options: minutes,
          style:{width: "3em"},
        });
         
        self.domNode.appendChild(self._hour.domNode);
        self.domNode.appendChild(document.createTextNode(" h  "));
        self.domNode.appendChild(self._minute.domNode);
        self.domNode.appendChild(document.createTextNode(" m  "));
      },
      _setValueAttr: function(value) {
        this.value = value;
      },
      _getValueAttr: function() {
        return this.value;
      },
      destroy: function() {
        this._hour.destroy();
        this._minute.destroy();
        this.inherited(arguments);
      }
    });
   
    var CustomEditorOperations = declare([_WidgetBase], {
      value: null,
      buildRendering: function() {
        var self = this;
        this.inherited(arguments);

        self._buttonLeg = new Button({
          label: "New leg"
        });
        self._buttonLayover = new Button({
          label: "New layover"
        });
        self._buttonDelete = new Button({
          iconClass: "dijitIconDelete"
        });

        self._buttonLeg.on("click", function() {
          console.log("self.grid.collection");
          console.log(self.grid.collection.len);

          self.grid.collection.put({pk: self.grid.collection.nextPk, order: self.value.order + 0.1, lblType: "Leg", type: "leg", btnAction: 2, datetime: 0, duration:99});
          self.grid.collection.put({pk: self.grid.collection.nextPk, order: self.value.order + 0.2, btnAction: 1, slctAction: 1, type: "sta"});

          reordonateStore(self.grid.collection);
        });
        self._buttonLayover.on("click", function() {
          self.grid.collection.put({pk: self.grid.collection.nextPk, order: self.value.order + 0.1, lblType: "Lay over", type: "lay", btnAction: 2, datetime: 0, duration:99});
          self.grid.collection.put({pk: self.grid.collection.nextPk, order: self.value.order + 0.2, btnAction: 1, slctAction: 0, type: "sta", station: self.value.station});
          
          reordonateStore(self.grid.collection);
        });


        self._buttonDelete.on("click", function() {
          console.log("delete button");
          if( self.value.order != self.grid.collection.len -1 ) {
            self.grid.collection.filter({order: self.value.order + 1}).forEach( function (object) {
              console.log(object);
              self.grid.collection.remove(object.pk);
            });
          } 
          else {
            // as this is the last leg/layover in the ordered list, I need to delete the current
            // leg/layover and the previous station, because the next one is untouchable, required
            // as the destination station.
            self.grid.collection.filter({order: self.value.order - 1}).forEach( function (object) {
              console.log(object);
              self.grid.collection.remove(object.pk);
            });
          }

          self.grid.collection.remove(self.value.pk);
          reordonateStore(self.grid.collection);
        });
 
      },
      _setValueAttr: function(value) {
        this.value = value;

        if (this.value.btnAction == 1 ){
         this.domNode.appendChild(this._buttonLeg.domNode);
         this.domNode.appendChild(this._buttonLayover.domNode);
        }
        else if( this.value.btnAction == 2  && this.grid.collection.len > 3 ){
         this.domNode.appendChild(this._buttonDelete.domNode);
        }

      },
      _getValueAttr: function() {
        return this.value;
      },
      destroy: function() {
        this._buttonLeg.destroy();
        this._buttonLayover.destroy();
        this._buttonDelete.destroy();
        this.inherited(arguments);
      }
    });

    function reordonateStore(store) {
      var i = store.len;
      
      store.sort('order', [ { descending: true } ]).forEach(function (object) {
        // called for each item in the final result set
        object.order = i;
        store.put(object);
        console.log(object);
        i --; 
                    });

    }


  var ActivityModel = declare(Model, {
    schema: {
      pk: "numeric",
      order: "numeric",
      btnAction: "numeric",
      type: "string",
      station: "string", 
      datetime: "numeric",
      duration: "numeric",
      status: "string",
    },
    validateOnSet: false,
  });

  var TrackableMemory = declare([Memory, Trackable]);
  
   var activityStore = new TrackableMemory({
    Model: ActivityModel,
    idProperty: "pk",
    len: 0,
    nextPk: 1,
  });


  activityStore.on('add', function(event){
    console.log('add item in store');
     activityStore.len += 1;
     activityStore.nextPk += 1;
   }); 
   activityStore.on('delete', function(event){
    console.log('delete item in store');
     activityStore.len -= 1;
   }); 


   activityStore.addSync({
    pk: 1,
    order: 1,
    btnAction: 1,
    slctAction: 0, 
    type: "sta",
    station: "AUH",
   });
   activityStore.addSync({
    pk: 2,
    order: 2,
    btnAction: 2,
    type: "leg",
    lblType: "Leg",
    datetime: 1490905094,
    duration: 250*60,
   });
   activityStore.addSync({
    pk: 3,
    order: 3,
    btnAction: 1,
    slctAction: 1, 
    type: "sta",
    station: "ATH",
   });
   activityStore.addSync({
    pk: 4,
    order: 4,
    btnAction: 2,
    type: "lay",
    lblType: "Lay over",
    datetime: 1490905094,
    duration: 350*60,
   });
   activityStore.addSync({
    pk: 5,
    order: 5,
    btnAction: 1,
    slctAction: 0, 
    type: "sta",
    station: "ATH",
   });
   activityStore.addSync({
    pk: 6,
    order: 6,
    btnAction: 2,
    type: "leg",
    lblType: "Leg",
    datetime: 1490905094,
    duration: 450*60,
   });
   activityStore.addSync({
    pk: 7,
    order: 7,
    btnAction: 0,
    slctAction: 0, 
    type: "sta",
    station: "AUH",
   });


    var typeData = {
	identifier: 'type',
	items: [
		{ 'type': 'leg', 'name': 'Leg' },
		{ 'type': 'lay', 'name': 'Lay over' },
               ]
    };

    typeStore = new ObjectStore({
      objectStore: LegacyObservable(new LegacyMemory({data: typeData})),
      labelProperty: "name"
    });

    var stationData = {
      identifier: 'code',
      items: [
      {'code':'ADD', 'name':'Addis Ababa'},
      {'code':'ALA', 'name':'Almaty'},
      {'code':'AMD', 'name':'Ahmedabad'},
      {'code':'AMM', 'name':'Amman Queen Alia International Apt'},
      {'code':'AMS', 'name':'Amsterdam'},
      {'code':'ATH', 'name':'Athens'},
      {'code':'AUH', 'name':'Abu Dhabi International Apt'},
      {'code':'BAH', 'name':'Bahrain'},
      {'code':'BEN', 'name':'Benghazi'},
             ]

    };

    stationStore = new ObjectStore({
      objectStore: LegacyObservable(new LegacyMemory({data: stationData})),
      labelProperty: "code",
    });


   var grid = new (declare([Grid, Selection, Keyboard, Editor]))(
                     { collection: activityStore},
                     'grid'
                   );
   var columns = [
      { field: 'pk',
        label: 'PK',
        sortable: false,
      },
      { field: 'order',
        label: 'Order',
        sortable: false,
      },
      {
        label: "Station",
        field: "station",
        sortable: false,
        editor: FilteringSelect,
        editorArgs: {
          store: stationStore,
          maxHeight: 150,
          style: "width:6em;",
          labelAttr: "code",
          searchAttr: "code",
//          onChange: function(value){
//            console.log("select station change");
//            console.log(value);
//          }
          
        },
        canEdit: function (object, value) {
          return object.slctAction;
        },

      },
      {
        label: "Type",
        field: "lblType",
        sortable: false,
      },
      { field: 'duration',
        label: 'Duration',
        sortable: false,
        editor: DurationInput,
        editorArgs: {
          grid: grid         
        }
      },
      {
        label: 'Operations',
        sortable: false,
        editor: CustomEditorOperations,
        editorArgs:{
          grid: grid 
        },
      },



     ];

   grid.on("dgrid-datachange",function(event) {
     console.log("tigidou, c'est la que ca se passe.");
     console.log(event);
     console.log(event.cell.row.data);
     // je vais pouvoir intervenir ici pour faire le sync de la station
     // dans le cas d'un layover....
   });

   grid.set('columns',columns);
   grid.set('sort', 'order');

//   grid.startup();


});

</script>


  </head>
  <body class="claro">

    <div data-dojo-type="dijit/MenuItem" id="destroy"
				 data-dojo-props="iconClass:'dijitIconDelete'">Destroy All
			</div>
    <h2>A basic trip grid with memory store</h2>
    <div id="grid"></div>
  </body>
</html>
